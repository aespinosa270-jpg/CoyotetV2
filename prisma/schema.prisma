generator client {
  provider      = "prisma-client-js"
  // Vital para Vercel
  binaryTargets = ["native", "rhel-openssl-1.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================================
// ENUMS: REGLAS DE NEGOCIO ESTRICTAS
// ==========================================================

enum EmployeeRole {
  ADMIN
  SUPERVISOR
  VENDEDORA
  LOGISTICA
  CONTABILIDAD
}

enum OrderStatus {
  PENDING         // Creada, esperando pago
  PAID            // Pago OpenPay confirmado
  PROCESSING      // En almacén armando bultos
  SHIPPED         // Guía generada / En flotilla
  DELIVERED       // Entregado
  CANCELLED
  FAILED          // Pago rechazado por OpenPay ← NUEVO
}

enum LogisticsType {
  COYOTE_LOCAL
  SKYDROPX_NACIONAL
}

// ==========================================================
// 1. EL USUARIO / CLIENTE (Blindado)
// ==========================================================
model User {
  id            String    @id @default(cuid())
  
  // Hash B2B seguro para el CRM (Generado por Postgres)
  hashId        String    @unique @default(dbgenerated("concat('CL-', substr(gen_random_uuid()::text, 1, 6))"))
  
  // Datos Base (Tu estructura original)
  name          String?
  email         String    @unique
  password      String    
  image         String?
  phone         String?
  role          String    @default("silver") // Mantenemos tu jerarquía: silver, gold, black
  
  // KPIs de Negocio
  ltv           Float     @default(0) // Suma histórica de compras

  // Datos Fiscales y Domicilio B2B
  rfc           String?
  taxRegime     String?
  cfdiUse       String?
  street        String?
  neighborhood  String?
  zipCode       String?
  city          String?
  state         String?

  // Sistema de Consentimiento LFPDPPP (La Biblia)
  optedIn       Boolean   @default(false)
  suppressed    Boolean   @default(false)
  consentDate   DateTime?
  optOutDate    DateTime?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relaciones
  orders        Order[]   
}

// ==========================================================
// 2. EQUIPO INTERNO Y SEGURIDAD CRM (Nuevo)
// ==========================================================
model Employee {
  id            String         @id @default(cuid())
  name          String
  email         String         @unique
  password      String         
  role          EmployeeRole   @default(VENDEDORA)
  
  // Kill Switch: Desactivación inmediata
  isActive      Boolean        @default(true) 
  
  logs          AuditLog[]
  
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
}

// Trazabilidad Total (El Ojo del CEO)
model AuditLog {
  id            String         @id @default(cuid())
  timestamp     DateTime       @default(now())
  
  employeeId    String
  employee      Employee       @relation(fields: [employeeId], references: [id])
  
  action        String         // ej: "VIEW_CLIENT_PHONE"
  resourceId    String?        
  ipAddress     String?
  userAgent     String?
  metadata      Json?          
}

// ==========================================================
// 3. E-COMMERCE & LOGÍSTICA
// ==========================================================
model Order {
  id            String         @id @default(cuid())
  orderNumber   String         @unique @default(cuid()) // Para facturas (CYT-001)
  
  // Conexión con el User
  userId        String
  user          User           @relation(fields: [userId], references: [id])

  // Desglose Financiero "Sabroso"
  subtotal      Float          @default(0)
  freightCost   Float          @default(0)
  shippingCost  Float          @default(0)
  serviceFee    Float          @default(0)
  taxIVA        Float          @default(0)
  total         Float

  // Estado y Pagos
  status        OrderStatus    @default(PENDING) // Usando el nuevo Enum
  paymentMethod String         @default("card")
  paymentId     String?        // ID de transacción de OpenPay
  
  // Logística 
  logisticsType LogisticsType  @default(SKYDROPX_NACIONAL)
  vehiclesNeeded Int           @default(1)
  trackingNumber String?       
  trackingUrl   String?

  // Datos del Cliente (Snapshot histórico original)
  customerName  String
  customerEmail String
  customerPhone String?
  address       String?
  
  // Facturación
  wantsInvoice  Boolean        @default(false)
  invoiceStatus String?        // PENDING, GENERATED

  items         OrderItem[]
  
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
}

model OrderItem {
  id            String   @id @default(cuid())
  
  // Conexión con la Orden padre
  orderId       String
  order         Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  // Detalles del producto
  productId     String
  title         String
  sku           String?
  price         Float
  quantity      Float
  unit          String?
  color         String?
}